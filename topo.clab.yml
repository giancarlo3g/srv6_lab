name: srv6
prefix: ""

mgmt:
  network: net3         # management network name
  ipv4-subnet: 172.20.20.0/24       # ipv4 range

topology:
  defaults:
    kind: nokia_sros
  kinds:
    nokia_sros:
      image: registry.srlinux.dev/pub/nokia_sros:24.10.R1
      license: ../license-sros24.txt
    nokia_srsim:
      image: registry.srlinux.dev/pub/nokia_srsim:25.7.R1
      license: ../license-srsim25.txt
    linux:
      image: ghcr.io/mfzhsn/network-multitool-sshd:0.0.2
  nodes:
  # Ring-1: RSVP access ring
    R01-IXR: #IXR-R6
      kind: nokia_srsim
      type: ixr-r6
      env:
        NOKIA_SROS_MDA_1: m4-10g-sfp++1-100g-cfp2
        NOKIA_SROS_MDA_2: m6-10g-sfp++1-100g-qsfp28
      # startup-config: ./config/R01-IXR.cfg
      mgmt-ipv4: 172.20.20.101
      ports:
        - 50101:22
        - 50102:57400
        - 50103:830  
    R02-IXR: #IXR-e2
      kind: nokia_srsim
      type: ixr-e2   
      # startup-config: ./config/R02-IXR.cfg
      mgmt-ipv4: 172.20.20.102
      ports:
        - 50201:22
        - 50202:57400
        - 50203:830
    R03-IXR: #IXR-R6
      kind: nokia_srsim
      type: ixr-r6
      env:
        NOKIA_SROS_MDA_1: m4-10g-sfp++1-100g-cfp2
        NOKIA_SROS_MDA_2: m6-10g-sfp++1-100g-qsfp28
      # startup-config: ./config/R03-IXR.cfg
      mgmt-ipv4: 172.20.20.103
      ports:
        - 50301:22
        - 50302:57400
        - 50303:830
    R04-IXR: #IXR-R6
      kind: nokia_srsim
      type: ixr-r6
      env:
        NOKIA_SROS_MDA_1: m4-10g-sfp++1-100g-cfp2
        NOKIA_SROS_MDA_2: m6-10g-sfp++1-100g-qsfp28
      # startup-config: ./config/R04-IXR.cfg
      mgmt-ipv4: 172.20.20.104
      ports:
        - 50401:22
        - 50402:57400
        - 50403:830
    # Core SRv6
    R05-SR: #SR-1 (ASBR)
      kind: nokia_srsim
      type: sr-1
      # startup-config: ./config/R05-SR.cfg
      mgmt-ipv4: 172.20.20.105
      ports:
        - 50501:22
        - 50502:57400
        - 50503:830
    R06-SR: #SR-1 (ASBR)
      kind: nokia_srsim
      type: sr-1
      # startup-config: ./config/R06-SR.cfg
      mgmt-ipv4: 172.20.20.106
      ports:
        - 50601:22
        - 50602:57400
        - 50603:830
    R07-SR: #SR-1
      kind: nokia_srsim
      type: sr-1
      # startup-config: ./config/R07-SR.cfg
      mgmt-ipv4: 172.20.20.107
      ports:
        - 50701:22
        - 50702:57400
        - 50703:830
    R08-SR: #SR-1
      kind: nokia_srsim
      type: sr-1
      # startup-config: ./config/R08-SR.cfg
      mgmt-ipv4: 172.20.20.108
      ports:
        - 50801:22
        - 50802:57400
        - 50803:830
    R09-SR: #SR-1
      kind: nokia_srsim
      type: sr-1
      # startup-config: ./config/R09-SR.cfg
      mgmt-ipv4: 172.20.20.109
      ports:
        - 50901:22
        - 50902:57400
        - 50903:830
    R10-SR: #SR-1
      kind: nokia_srsim
      type: sr-1
      # startup-config: ./config/R10-SR.cfg
      mgmt-ipv4: 172.20.20.110
      ports:
        - 51001:22
        - 51002:57400
        - 51003:830
    R11-SR: #SR-1 (ASBR)
      kind: nokia_srsim
      type: sr-1
      # startup-config: ./config/R11-SR.cfg
      mgmt-ipv4: 172.20.20.111
      ports:
        - 51101:22
        - 51102:57400
        - 51103:830
    R12-SR: #SR-1 (ASBR)
      kind: nokia_srsim
      type: sr-1
      # startup-config: ./config/R12-SR.cfg
      mgmt-ipv4: 172.20.20.112
      ports:
        - 51201:22
        - 51202:57400
        - 51203:830
    # Ring-2: SRv6 access ring
    R13-IXR: #IXR-R6d
      kind: nokia_srsim
      type: ixr-r6d
      components:
        - slot: A
        - slot: 1
          env:
            NOKIA_SROS_CARD: iom-ixr-r6d
            NOKIA_SROS_MDA_1: m5-100g-qsfp28
      # startup-config: ./config/R13-IXR.cfg
      mgmt-ipv4: 172.20.20.113
      ports: 
        - 51301:22
        - 51302:57400
        - 51303:830
    # R13-IXR: #IXR-R6d
    #   kind: nokia_sros
    #   type: >-
    #       cp: cpu=2 ram=4 chassis=ixr-r6d slot=A card=cpm-ixr-r6d/iom-ixr-r6d ___
    #       lc: cpu=4 ram=6 chassis=ixr-r6d slot=1 card=cpm-ixr-r6d/iom-ixr-r6d mda/1=m5-100g-qsfp28
    #   startup-config: ./config/R13-IXR.cfg
    #   mgmt-ipv4: 172.20.20.113
    #   ports: 
    #     - 51301:22
    #     - 51302:57400
    #     - 51303:830
    R14-IXR: #IXR-e2
      kind: nokia_srsim
      type: ixr-e2
      # startup-config: ./config/R14-IXR.cfg
      mgmt-ipv4: 172.20.20.114
      ports:
        - 51401:22
        - 51402:57400
        - 51403:830
    R15-IXR: #IXR-R6d
      kind: nokia_srsim
      type: ixr-r6d
      components:
        - slot: A
        - slot: 1
          env:
            NOKIA_SROS_CARD: iom-ixr-r6d
            NOKIA_SROS_MDA_1: m5-100g-qsfp28
      # startup-config: ./config/R15-IXR.cfg
      mgmt-ipv4: 172.20.20.115
      ports:
        - 51501:22
        - 51502:57400
        - 51503:830
    R16-IXR: #IXR-e2
      kind: nokia_srsim
      type: ixr-e2
      # startup-config: ./config/R16-IXR.cfg
      mgmt-ipv4: 172.20.20.116
      ports:
        - 51601:22
        - 51602:57400
        - 51603:830  
    tester1:
      kind: linux
      mgmt-ipv4: 172.20.20.120
      exec:
        - ip link add link eth1 name eth1.10 type vlan id 10
        - ifconfig eth1.10 192.168.0.1
        - ifconfig eth1.10 netmask 255.255.255.0 
    tester2:
      kind: linux
      mgmt-ipv4: 172.20.20.121
      exec:
        - ifconfig eth1 192.168.0.2
        - ifconfig eth1 netmask 255.255.255.0
    tester3:
      kind: linux
      mgmt-ipv4: 172.20.20.122
      exec:
        - ifconfig eth1 192.168.0.3
        - ifconfig eth1 netmask 255.255.255.0
    tester4:
      kind: linux
      mgmt-ipv4: 172.20.20.123
      exec:
        - ip link add link eth1 name eth1.413 type vlan id 413
        - ifconfig eth1.413 10.4.13.4
        - ifconfig eth1.413 netmask 255.255.255.0
    tester5:
      kind: linux
      mgmt-ipv4: 172.20.20.124
      exec:
        - ip link add link eth1 name eth1.516 type vlan id 516
        - ifconfig eth1.516 10.5.16.5
        - ifconfig eth1.516 netmask 255.255.255.0
    tester11:
      kind: linux
      mgmt-ipv4: 172.20.20.125
      exec:
        - ifconfig eth1 192.168.0.11
        - ifconfig eth1 netmask 255.255.255.0
    tester13:
      kind: linux
      mgmt-ipv4: 172.20.20.126
      exec:
        - ip link add link eth1 name eth1.413 type vlan id 413
        - ip link add link eth1 name eth1.1316 type vlan id 1316
        - ifconfig eth1.413 10.4.13.13
        - ifconfig eth1.413 netmask 255.255.255.0
        - ifconfig eth1.1316 10.13.16.13
        - ifconfig eth1.1316 netmask 255.255.255.0
    tester14:
      kind: linux
      mgmt-ipv4: 172.20.20.127
      exec:
        - ip link add link eth1 name eth1.10 type vlan id 10
        - ifconfig eth1.10 192.168.0.14
        - ifconfig eth1.10 netmask 255.255.255.0
    tester16:
      kind: linux
      mgmt-ipv4: 172.20.20.128
      exec:
        - ip link add link eth1 name eth1.516 type vlan id 516
        - ip link add link eth1 name eth1.1316 type vlan id 1316
        - ifconfig eth1.516 10.5.16.16
        - ifconfig eth1.516 netmask 255.255.255.0
        - ifconfig eth1.1316 10.13.16.16
        - ifconfig eth1.1316 netmask 255.255.255.0

#################################################################################################################################################
#Telemetry 
#################################################################################################################################################
    gnmic:
      kind: linux
      image: ghcr.io/openconfig/gnmic
      mgmt-ipv4: 172.20.20.150
      binds:
        - ./tele-config/gnmic.yaml:/app/gnmic.yaml:ro
        - /var/run/docker.sock:/var/run/docker.sock
      cmd: "--config /app/gnmic.yaml --log subscribe"

    consul-agent:
      kind: linux
      image: consul:1.15.4
      mgmt-ipv4: 172.20.20.151
      ports:
        - 8500:8500
        - 8600:8600/udp
      cmd: "agent -server -ui -bind=127.0.0.1 -node=server-1 -bootstrap-expect=1 -client=0.0.0.0"

    prometheus:
      kind: linux
      image: prom/prometheus:latest
      mgmt-ipv4: 172.20.20.152
      user: 65534:65534
      ports:
        - 9090:9090
      binds:
        - ./tele-config/prometheus:/etc/prometheus/
      cmd: |
        --config.file=/etc/prometheus/prometheus.yaml
        --web.console.libraries=/usr/share/prometheus/console_libraries
        --web.console.templates=/usr/share/prometheus/consoles
        --log.level=debug

    grafana:
      kind: linux
      image: grafana/grafana:latest
      mgmt-ipv4: 172.20.20.153
      binds:
        - ./tele-config/grafana/datasources/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml:ro
        - ./tele-config/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
        - ./tele-config/grafana/dashboards:/var/lib/grafana/dashboards
      ports:
        - 3000:3000 

  links:
  #Connections
    - endpoints: ["R01-IXR:1/1/5", "R02-IXR:1/1/c3/1"]
    - endpoints: ["R01-IXR:1/2/c7/1", "R03-IXR:1/2/c7/1"]
    - endpoints: ["R01-IXR:1/1/1", "tester1:eth1"]
    - endpoints: ["R03-IXR:1/1/1", "tester3:eth1"]
    - endpoints: ["R03-IXR:1/1/5", "R05-SR:1/1/c1/1"]
    - endpoints: ["R05-SR:1/1/c2/1", "R06-SR:1/1/c2/1"]
    - endpoints: ["R05-SR:1/1/c3/1", "R07-SR:1/1/c1/1"]
    - endpoints: ["R07-SR:1/1/c2/1", "R08-SR:1/1/c2/1"]
    - endpoints: ["R07-SR:1/1/c3/1", "R09-SR:1/1/c1/1"]
    - endpoints: ["R09-SR:1/1/c2/1", "R10-SR:1/1/c2/1"]
    - endpoints: ["R09-SR:1/1/c3/1", "R11-SR:1/1/c1/1"]
    - endpoints: ["R11-SR:1/1/c2/1", "R12-SR:1/1/c2/1"]
    - endpoints: ["R11-SR:1/1/c3/1", "R13-IXR:1/1/c1/1"]
    - endpoints: ["R13-IXR:1/1/c2/1", "tester13:eth1"]
    - endpoints: ["R13-IXR:1/1/c3/1", "R15-IXR:1/1/c1/1"]
    - endpoints: ["R15-IXR:1/1/c2/1", "R16-IXR:1/1/c1/1"]
    - endpoints: ["R16-IXR:1/1/c2/1", "tester16:eth1"]
    - endpoints: ["R15-IXR:1/1/c3/1", "R14-IXR:1/1/c1/1"]
    - endpoints: ["R14-IXR:1/1/c2/1", "tester14:eth1"]
    - endpoints: ["R14-IXR:1/1/c3/1", "R12-SR:1/1/c1/1"]
    - endpoints: ["R12-SR:1/1/c3/1", "R10-SR:1/1/c1/1"]
    - endpoints: ["R10-SR:1/1/c3/1", "R08-SR:1/1/c1/1"]
    - endpoints: ["R08-SR:1/1/c3/1", "R06-SR:1/1/c1/1"]
    - endpoints: ["R06-SR:1/1/c3/1", "R04-IXR:1/1/5"]
    - endpoints: ["R02-IXR:1/1/c1/1", "R04-IXR:1/2/c7/1"]
    - endpoints: ["R04-IXR:1/1/1", "tester4:eth1"]
    - endpoints: ["R02-IXR:1/1/c2/1", "tester2:eth1"]
    - endpoints: ["R05-SR:1/1/c4/1", "tester5:eth1"]
    - endpoints: ["R11-SR:1/1/c4/1", "tester11:eth1"]
